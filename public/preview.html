<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preview â€” Content Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
  <style>
    .preview-wrapper {
      min-height: 100vh;
      background: var(--surface-alt);
    }
    .preview-toolbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .phone-frame {
      width: 375px;
      margin: 2rem auto;
      background: var(--surface);
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      border: 8px solid #1e293b;
    }
    .phone-notch {
      height: 28px;
      background: #1e293b;
      border-radius: 0 0 16px 16px;
      width: 50%;
      margin: 0 auto;
    }
    .phone-content {
      min-height: 600px;
      padding: 0;
    }
    .phone-content .app-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.25rem;
      font-weight: 600;
      font-size: 1.125rem;
    }
    .phone-content .app-body {
      padding: 1rem 1.25rem;
    }
    .content-item {
      margin-bottom: 1.25rem;
    }
    .content-item .field-label {
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    .content-item .field-value {
      font-size: 0.9375rem;
      line-height: 1.6;
      color: var(--text);
    }
    .content-item .field-value.arabic {
      direction: rtl;
      text-align: right;
      font-family: 'Amiri', 'Traditional Arabic', serif;
      font-size: 1.25rem;
      line-height: 2;
    }
    .content-item .field-value.urdu {
      direction: rtl;
      text-align: right;
      font-family: 'Amiri', serif;
      font-size: 1.125rem;
      line-height: 1.8;
    }
    .media-section {
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--surface-alt);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .media-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.8125rem;
    }
    .media-link + .media-link {
      border-top: 1px solid var(--border);
    }
    .child-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0 0;
    }
    .child-list li {
      padding: 0.75rem 1rem;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .child-list li:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    .nav-back {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }
    .nav-back:hover { text-decoration: underline; }
    @media (max-width: 480px) {
      .phone-frame { width: 100%; border-radius: 0; border: none; margin: 0; }
    }
  </style>
</head>
<body>
  <div class="preview-wrapper">
    <!-- Toolbar -->
    <div class="preview-toolbar">
      <div class="d-flex align-items-center gap-3">
        <a href="/editor.html" class="btn btn-sm btn-outline-secondary">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Editor
        </a>
        <h6 class="mb-0" style="font-size:0.9375rem;">Preview</h6>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label class="form-label-custom mb-0 me-1" style="font-size:0.8125rem;">Language:</label>
        <select id="langSelect" class="form-select form-select-sm" style="width:auto;" onchange="changeLanguage()">
          <option value="en">English</option>
          <option value="gu">Gujarati</option>
          <option value="ar">Arabic</option>
          <option value="ur">Urdu</option>
        </select>
      </div>
    </div>

    <!-- Phone Preview -->
    <div class="phone-frame">
      <div class="phone-notch"></div>
      <div class="phone-content">
        <div class="app-header" id="previewHeader">Content Preview</div>
        <div class="app-body" id="previewBody">
          <div class="text-center text-muted py-5">
            <div class="spinner-border spinner-border-sm"></div><br>
            <small>Loading preview...</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/utils.js"></script>
  <script>
    if (!requireAuth()) throw new Error("Not authenticated");

    // Parse URL params
    const params = new URLSearchParams(window.location.search);
    let contentId = params.get("content_id");
    let lang = params.get("lang") || "en";

    // Set initial language selection
    document.getElementById("langSelect").value = lang;

    // Navigation history for back button
    const navHistory = [];

    // Load preview
    if (contentId) {
      loadPreview(contentId, lang);
    } else {
      loadRootPreview();
    }

    function changeLanguage() {
      lang = document.getElementById("langSelect").value;
      if (contentId) {
        loadPreview(contentId, lang);
      } else {
        loadRootPreview();
      }
    }

    async function loadRootPreview() {
      try {
        const data = await API.getTree("with-language", lang);
        const rows = data.rows || [];
        const roots = rows.filter((r) => r.parent_id === null || r.parent_id === undefined);
        roots.sort((a, b) => (a.sequence || 0) - (b.sequence || 0));

        document.getElementById("previewHeader").textContent = "Content Library";

        let html = "";
        if (roots.length === 0) {
          html = '<div class="text-center text-muted py-4"><p>No content available.</p></div>';
        } else {
          html += '<ul class="child-list">';
          for (const item of roots) {
            const title = item.title || item.type || `Item #${item.id}`;
            html += `<li onclick="navigateTo(${item.id})">
              <div>
                <div style="font-weight:600;">${escapeHtml(title)}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${item.type || "item"}</div>
              </div>
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </li>`;
          }
          html += "</ul>";
        }

        document.getElementById("previewBody").innerHTML = html;
      } catch (err) {
        document.getElementById("previewBody").innerHTML =
          `<div class="text-center text-danger py-4">Failed to load content.</div>`;
      }
    }

    async function loadPreview(id, language) {
      contentId = id;

      try {
        // Fetch tree with language and translations
        const [treeData, transData] = await Promise.all([
          API.getTree("with-language", language),
          API.getTranslations(id),
        ]);

        const allRows = treeData.rows || [];
        const item = allRows.find((r) => Number(r.id) === Number(id));
        const translations = transData.translations || {};
        const trans = translations[language] || {};

        if (!item) {
          document.getElementById("previewBody").innerHTML =
            '<div class="text-center text-muted py-4">Content not found.</div>';
          return;
        }

        const isRtl = language === "ar" || language === "ur";
        const textClass = language === "ar" ? "arabic" : language === "ur" ? "urdu" : "";

        // Header
        document.getElementById("previewHeader").textContent =
          trans.title || item.title || item.type || `Item #${item.id}`;

        let html = "";

        // Back navigation
        if (navHistory.length > 0 || item.parent_id) {
          html += `<div class="nav-back" onclick="goBack()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </div>`;
        }

        // Title
        if (trans.title) {
          html += `<div class="content-item">
            <div class="field-label">Title</div>
            <div class="field-value ${textClass}" ${isRtl ? 'dir="rtl"' : ''}>${escapeHtml(trans.title)}</div>
          </div>`;
        }

        // Original Text
        if (trans.original_text) {
          html += `<div class="content-item">
            <div class="field-label">Original Text</div>
            <div class="field-value ${textClass}" ${isRtl ? 'dir="rtl"' : ''} style="${item.css || ''}">${escapeHtml(trans.original_text)}</div>
          </div>`;
        }

        // Translation
        if (trans.translation) {
          html += `<div class="content-item">
            <div class="field-label">Translation</div>
            <div class="field-value">${escapeHtml(trans.translation)}</div>
          </div>`;
        }

        // Transliteration
        if (trans.transliteration) {
          html += `<div class="content-item">
            <div class="field-label">Transliteration</div>
            <div class="field-value" style="font-style:italic;color:var(--text-muted);">${escapeHtml(trans.transliteration)}</div>
          </div>`;
        }

        // Media links
        if (item.audio_url || item.video_url || item.duas_url) {
          html += '<div class="media-section">';
          if (item.audio_url) {
            html += `<a href="${escapeHtml(item.audio_url)}" target="_blank" class="media-link">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              Play Audio
            </a>`;
          }
          if (item.video_url) {
            html += `<a href="${escapeHtml(item.video_url)}" target="_blank" class="media-link">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                <line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/>
                <line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/>
                <line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/>
                <line x1="17" y1="17" x2="22" y2="17"/>
              </svg>
              Watch Video
            </a>`;
          }
          if (item.duas_url) {
            html += `<a href="${escapeHtml(item.duas_url)}" target="_blank" class="media-link">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
              </svg>
              Open Duas
            </a>`;
          }
          html += "</div>";
        }

        // Children
        const children = allRows
          .filter((c) => Number(c.parent_id) === Number(id))
          .sort((a, b) => (a.sequence || 0) - (b.sequence || 0));

        if (children.length > 0) {
          html += '<ul class="child-list">';
          for (const child of children) {
            const childTitle = child.title || child.type || `Item #${child.id}`;
            const childCount = allRows.filter((c) => Number(c.parent_id) === Number(child.id)).length;
            html += `<li onclick="navigateTo(${child.id})">
              <div>
                <div style="font-weight:600;" ${isRtl ? 'dir="rtl"' : ''}>${escapeHtml(childTitle)}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${child.type}${childCount > 0 ? ` (${childCount} items)` : ""}</div>
              </div>
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </li>`;
          }
          html += "</ul>";
        }

        // No content message
        if (!trans.title && !trans.original_text && !trans.translation && children.length === 0) {
          html += `<div class="text-center text-muted py-3">
            <p>No ${getLanguageName(language)} translation available for this item.</p>
          </div>`;
        }

        document.getElementById("previewBody").innerHTML = html;
      } catch (err) {
        console.error("Preview error:", err);
        document.getElementById("previewBody").innerHTML =
          `<div class="text-center text-danger py-4">Failed to load preview.</div>`;
      }
    }

    function navigateTo(id) {
      if (contentId) navHistory.push(contentId);
      loadPreview(id, lang);
    }

    function goBack() {
      const prevId = navHistory.pop();
      if (prevId) {
        loadPreview(prevId, lang);
      } else {
        contentId = null;
        loadRootPreview();
      }
    }

    function getLanguageName(code) {
      const names = { en: "English", gu: "Gujarati", ar: "Arabic", ur: "Urdu" };
      return names[code] || code.toUpperCase();
    }

    function escapeHtml(str) {
      if (!str) return "";
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
